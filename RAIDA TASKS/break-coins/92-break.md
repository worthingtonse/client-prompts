# **Function Specification: create\_break\_requests()**

This document specifies the create\_break\_requests() function. This function is responsible for creating a batch of requests to break one higher-denomination token into ten lower-denomination tokens.

## **Core Concepts:**

* **RAIDA (Redundant Array of Independent Detection Agents):** A decentralized network of 25 servers.  
* **Break Service:** A Change Service that de-authenticates one valid token and simultaneously authenticates ten new tokens of the next lower denomination.  
* **AN (Authenticity Number):** The 16-byte password for the token being broken.  
* **PAN (Proposed Authenticity Number):** The new 16-byte password for each of the ten new tokens being created.

## **Function Signature:**

function create\_break\_requests(token\_to\_break: {denomination: byte, serial\_number: uint32, an: byte\_array}, new\_tokens: array of {denomination: byte, serial\_number: uint32, pan: byte\_array}, session\_id: byte\_array, challenge\_bytes: array of 16-byte arrays): Array\<byte\[\]\> | string

* **Input Parameters:**  
  * token\_to\_break (object): The token that will be broken. Contains:  
    * denomination (byte): The denomination of the token.  
    * serial\_number (uint32): The 4-byte serial number.  
    * an (16-byte array): The Authenticity Number of the token.  
  * new\_tokens (array of 10 objects): An array containing exactly ten new tokens to be created. Each object contains:  
    * denomination (byte): The denomination of the new token.  
    * serial\_number (uint32): The 4-byte serial number.  
    * pan (16-byte array): The Proposed Authenticity Number for the new token.  
  * session\_id (4-byte array): The session ID for the transaction.  
  * challenge\_bytes (array of 16-byte arrays): An array containing 25 unique 16-byte challenges. The challenge at index i will be used in the request for RAIDA server i.  
* **Return Value:**  
  * An array of 25 complete, prepared byte arrays. Each byte array represents a full request intended for one of the 25 servers.  
  * Returns the string "failure" if any significant, unrecoverable error occurs (e.g., new\_tokens array does not contain exactly 10 items).

## **Request Structure Overview:**

Each "break" request consists of three main parts, concatenated in order:

1. **Request Header (32 bytes):** Contains metadata, including the target server ID and the command.  
2. **Request Body (251 bytes):** Contains the challenge, session ID, the token to be broken, and the ten new tokens to be created.  
3. **Termination Bytes (2 bytes):** A fixed sequence (0x3E 0x3E) to mark the end of the request.

## **Detailed Logic:**

The function will construct 25 distinct requests, one for each potential target server (Server ID 0 to 24).

### **1\. Request Body Construction (251 bytes):**

* The body is constructed by concatenating the following parts in order:  
  * **Challenge (16 bytes):** The corresponding 16-byte challenge from the challenge\_bytes input array for that server.  
  * **Session ID (4 bytes):** The session\_id parameter.  
  * **Token to Break (21 bytes):**  
    * denomination (1 byte)  
    * serial\_number (4 bytes)  
    * an (16 bytes)  
  * **New Tokens (210 bytes):** Iterate through the new\_tokens array. For each of the 10 new tokens, append its:  
    * denomination (1 byte)  
    * serial\_number (4 bytes)  
    * pan (16 bytes)

### **2\. Request Header Construction (32 bytes):**

Create a 32-byte header for each of the 25 servers. This function assumes **Encryption Type 0 (No Encryption)**.

* **Bytes 0-3:**  
  * Byte 0 (VR): 0x00  
  * Byte 1 (SP): 0x00  
  * Byte 2 (RI): **Server ID** (from 0x00 for server 0, up to 0x18 for server 24\)  
  * Byte 3 (SH): 0x00  
* **Bytes 4-5 (Command):**  
  * Byte 4 (CG): 0x09 (Command Group: Change)  
  * Byte 5 (CM): 0x5C (Command: Break, which is 92 in decimal)  
* **Bytes 6-15:** All set to 0x00.  
* **Byte 16 (EN):** 0x00 (Encryption Type: No Encryption).  
* **Bytes 17-21:** All set to 0x00.  
* **Bytes 22-23 (BL):** The length of the body (251) plus two termination bytes (2), for a total of 253\. This will be 0x00FD (big-endian).  
* **Bytes 24-29:** All set to 0x00.  
* **Bytes 30-31 (Echo):** Two randomly generated bytes.

### **3\. Termination Bytes:**

* After the header and body, append two fixed termination bytes: 0x3E 0x3E.

### **4\. Final Request Assembly:**

* For each of the 25 servers, concatenate the constructed Header, its corresponding Body, and the Termination Bytes into a single byte array.  
* Return the array containing all 25 complete request byte arrays.

## **Logging and Error Handling:**

* **Success:** Log key milestones, such as the start of the function and its successful completion.  
* **Errors:** Log any errors encountered during the process, especially if the new\_tokens array does not contain exactly 10 items. Any error that prevents the successful creation of all 25 requests should cause the function to log the error and return the string "failure".
