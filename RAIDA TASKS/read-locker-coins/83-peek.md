# **Function Specification: create\_peek\_requests()**

This document specifies the create\_peek\_requests() function. This function is responsible for creating a batch of requests to "peek" inside a RAIDA locker and retrieve the serial numbers of the tokens it contains.

## **Core Concepts:**

* **RAIDA (Redundant Array of Independent Detection Agents):** A decentralized network of 25 servers.  
* **Locker:** A virtual container on the RAIDA that holds tokens.  
* **Locker Key:** The 16-byte key (a specific PAN) that secures a locker.

## **Function Signature:**

function create\_peek\_requests(locker\_key: byte\_array, challenge\_bytes: array of 16-byte arrays, encryption\_type: integer): Array\<byte\[\]\> | string

* **Input Parameters:**  
  * locker\_key (16-byte array): The key for the locker you want to peek into.  
  * challenge\_bytes (array of 16-byte arrays): An array containing 25 unique 16-byte challenges. The challenge at index i will be used in the request for RAIDA server i.  
  * encryption\_type (integer): Specifies the encryption mode.  
    * 0: No encryption.  
    * 2: Special locker key encryption. The request body is encrypted using the locker\_key itself.  
* **Return Value:**  
  * An array of 25 complete, prepared byte arrays. Each byte array represents a full request intended for one of the 25 servers.  
  * Returns the string "failure" if any significant, unrecoverable error occurs.

## **Request Structure Overview:**

Each "peek" request consists of three main parts, concatenated in order:

1. **Request Header (32 bytes):** Contains metadata, including the target server ID, command, and encryption details.  
2. **Request Body (32 bytes):** Contains the challenge and the locker key. This body may be encrypted.  
3. **Termination Bytes (2 bytes):** A fixed sequence (0x3E 0x3E) to mark the end of the request.

## **Detailed Logic:**

The function will construct 25 distinct requests, one for each potential target server (Server ID 0 to 24).

### **1\. Request Body Construction (32 bytes):**

* For each of the 25 servers, the initial unencrypted body is constructed by concatenating:  
  * **Challenge (16 bytes):** The corresponding 16-byte challenge from the challenge\_bytes input array.  
  * **Locker Key (16 bytes):** The locker\_key parameter.

### **2\. Request Header Construction (32 bytes):**

Create a 32-byte header for each of the 25 servers.

* **Bytes 0-3:**  
  * Byte 0 (VR): 0x00  
  * Byte 1 (SP): 0x00  
  * Byte 2 (RI): **Server ID** (from 0x00 for server 0, up to 0x18 for server 24\)  
  * Byte 3 (SH): 0x00  
* **Bytes 4-5 (Command):**  
  * Byte 4 (CG): 0x08 (Command Group: Locker Services)  
  * Byte 5 (CM): 0x53 (Command: Peek, which is 83 in decimal)  
* **Bytes 6-15:** All set to 0x00.  
* **Byte 16 (EN):** The encryption\_type parameter (0x00 or 0x02).  
* **Bytes 17-31:** Handled based on encryption\_type:  
  * **If encryption\_type is 0 (No Encryption):**  
    * Bytes 17-21: Set to 0x00.  
    * Bytes 22-23 (BL): The length of the body (32) plus two termination bytes (2), for a total of 34\. This will be 0x0022 (big-endian).  
    * Bytes 24-29: Set to 0x00.  
    * Bytes 30-31 (Echo): Two randomly generated bytes.  
  * **If encryption\_type is 2 (Locker Key Encryption):**  
    * Bytes 17-21: The **first five bytes** of the locker\_key.  
    * Bytes 22-23 (BL): The length of the encrypted body (32) plus two termination bytes (2), for a total of 34\. This will be 0x0022 (big-endian).  
    * Bytes 24-31 (Nonce): A randomly generated 8-byte nonce for AES CTR mode encryption.

### **3\. Encryption (for Encryption Type 2):**

* If encryption\_type is 2, encrypt the entire 32-byte request body (Challenge \+ Locker Key) using AES 128 CTR mode.  
* The **encryption key** is the 16-byte locker\_key.  
* The **nonce** is the 8-byte random nonce generated for bytes 24-31 of the header.

### **4\. Termination Bytes:**

* After the header and (potentially encrypted) body, append two fixed termination bytes: 0x3E 0x3E.

### **5\. Final Request Assembly:**

* For each of the 25 servers, concatenate the constructed Header, its corresponding Body (encrypted if type 2), and the Termination Bytes into a single byte array.  
* Return the array containing all 25 complete request byte arrays.

## **Logging and Error Handling:**

* **Success:** Log key milestones, such as the start of the function and its successful completion.  
* **Errors:** Log any errors encountered during the process (e.g., invalid input parameters or encryption failures). Any error that prevents the successful creation of all 25 requests should cause the function to log the error and return the string "failure".
