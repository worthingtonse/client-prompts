# **Function Specification: create\_fix\_requests()**

This document specifies the create\_fix\_requests() function. This function is responsible for creating a batch of requests to be sent to "fractured" RAIDA servers to heal tokens that have inconsistent authenticity status across the network.

## **Core Concepts:**

* **RAIDA (Redundant Array of Independent Detection Agents):** A decentralized network of 25 servers.  
* **Fractured Token:** A token that is considered authentic by some RAIDA servers but counterfeit by others.  
* **Ticket:** A 4-byte piece of data obtained from a trusted RAIDA server via the get-ticket command, serving as proof of a token's authenticity.  
* **PAN Generator (PG):** A 16-byte random seed used by the client and RAIDA to deterministically generate new Proposed Authenticity Numbers (PANs) for the tokens being fixed.

## **Function Signature:**

function create\_fix\_requests(tokens\_to\_fix: array of {denomination: byte, serial\_number: uint32}, pan\_generator: byte\_array, tickets: array of 4-byte arrays, challenge\_bytes: array of 16-byte arrays): Array\<byte\[\]\> | string

* **Input Parameters:**  
  * tokens\_to\_fix (array of objects): An array of tokens that need fixing. Each object contains:  
    * denomination (byte): The denomination of the token.  
    * serial\_number (uint32): The 4-byte serial number of the token.  
  * pan\_generator (16-byte array): The 16-byte random seed for generating new PANs.  
  * tickets (array of 4-byte arrays): An array of 25 tickets. The ticket at index i is the one obtained from RAIDA server i. If no ticket was obtained from a server, its 4 bytes should be all zeros (0x00).  
  * challenge\_bytes (array of 16-byte arrays): An array containing 25 unique 16-byte challenges. The challenge at index i will be used in the request for RAIDA server i.  
* **Return Value:**  
  * An array of 25 complete, prepared byte arrays. Each byte array represents a full request intended for one of the 25 servers. The client is responsible for sending these requests only to the RAIDA servers that are fractured.  
  * Returns the string "failure" if any significant, unrecoverable error occurs.

## **Request Structure Overview:**

Each "fix" request consists of three main parts, concatenated in order:

1. **Request Header (32 bytes):** Contains metadata, including the target server ID and the command.  
2. **Request Body (variable length):** Contains the list of tokens to fix, the PAN generator, and the 25 tickets.  
3. **Termination Bytes (2 bytes):** A fixed sequence (0x3E 0x3E) to mark the end of the request.

## **Detailed Logic:**

The function will construct 25 distinct requests, one for each potential target server (Server ID 0 to 24). The request body will be identical for all 25 requests.

### **1\. Request Body Construction (variable length):**

* Let N be the number of tokens in the tokens\_to\_fix array.  
* The total body length will be 16 \+ (N \* 5\) \+ 16 \+ 100 \= 132 \+ (N \* 5\) bytes.  
* The body is constructed by concatenating the following parts in order:  
  * **Challenge (16 bytes):** The corresponding 16-byte challenge from the challenge\_bytes input array.  
  * **Tokens to Fix (N \* 5 bytes):** Iterate through the tokens\_to\_fix array. For each token, append its 1-byte denomination followed by its 4-byte serial\_number.  
  * **PAN Generator (16 bytes):** Append the 16-byte pan\_generator.  
  * **Tickets (100 bytes):** Append all 25 tickets from the tickets array. Each ticket is 4 bytes, for a total of 25 \* 4 \= 100 bytes.

### **2\. Request Header Construction (32 bytes):**

Create a 32-byte header for each of the 25 servers. This function assumes **Encryption Type 0 (No Encryption)**.

* **Bytes 0-3:**  
  * Byte 0 (VR): 0x00  
  * Byte 1 (SP): 0x00  
  * Byte 2 (RI): **Server ID** (from 0x00 for server 0, up to 0x18 for server 24\)  
  * Byte 3 (SH): 0x00  
* **Bytes 4-5 (Command):**  
  * Byte 4 (CG): 0x02 (Command Group: Healing)  
  * Byte 5 (CM): 0x50 (Command: Fix, which is 80 in decimal)  
* **Bytes 6-15:** All set to 0x00.  
* **Byte 16 (EN):** 0x00 (Encryption Type: No Encryption).  
* **Bytes 17-21:** All set to 0x00.  
* **Bytes 22-23 (BL):** The length of the body plus two termination bytes. This will be (132 \+ (N \* 5)) \+ 2 \= 134 \+ (N \* 5). This value is represented as a 16-bit unsigned integer (big-endian).  
* **Bytes 24-29:** All set to 0x00.  
* **Bytes 30-31 (Echo):** Two randomly generated bytes.

### **3\. Termination Bytes:**

* After the header and body, append two fixed termination bytes: 0x3E 0x3E.

### **4\. Final Request Assembly:**

* For each of the 25 servers, concatenate the constructed Header, the single shared Body, and the Termination Bytes into a single byte array.  
* Return the array containing all 25 complete request byte arrays.

## **Logging and Error Handling:**

* **Success:** Log key milestones, such as the start of the function and its successful completion.  
* **Errors:** Log any errors encountered during the process (e.g., invalid input parameters). Any error that prevents the successful creation of all 25 requests should cause the function to log the error and return the string "failure".
